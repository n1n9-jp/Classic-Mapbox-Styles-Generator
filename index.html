<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Mapbox URL ジェネレーター</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        line-height: 1.6;
        margin: 2rem auto;
        max-width: 640px;
        padding: 0 1rem;
      }

      h1 {
        font-size: 1.6rem;
        margin-bottom: 1rem;
      }

      label {
        display: block;
        font-weight: 600;
        margin-top: 1rem;
      }

      input,
      select,
      button {
        width: 100%;
        padding: 0.6rem;
        margin-top: 0.5rem;
        font-size: 1rem;
      }

      button {
        cursor: pointer;
        background-color: #146aff;
        color: #fff;
        border: none;
        border-radius: 4px;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .message {
        margin-top: 1rem;
        font-size: 0.95rem;
        color: #c62828;
      }

      .result {
        margin-top: 1.5rem;
        word-break: break-all;
        background-color: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
      }

      .copy-button {
        margin-top: 0.5rem;
        background-color: #3949ab;
      }

      .download-button {
        margin-top: 0.5rem;
        background-color: #00897b;
      }

      .preview-wrapper {
        margin-top: 1rem;
        padding: 1rem;
        background: #f0f4ff;
        border-radius: 4px;
        border: 1px solid #d4defc;
      }

      .preview-wrapper img {
        display: block;
        width: 100%;
        max-width: 320px;
        height: auto;
        border-radius: 4px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
      }
    </style>
  </head>
  <body>
    <h1>Mapbox スタイル URL 生成</h1>
    <p>
      トークンを入力し、スタイルを選んでください。Mapbox Classic スタイル用の API URL を生成します。
    </p>

    <form id="generator-form">
      <label for="token">アクセストークン (TOKEN)</label>
      <input
        type="text"
        id="token"
        name="token"
        placeholder="pk.XXXXXXXXXXXX"
        autocomplete="off"
        required
      />

      <label for="style">スタイル (SLUG)</label>
      <select id="style" name="style" required>
        <option value="">スタイルを選択してください</option>
      </select>

      <figure id="preview-wrapper" class="preview-wrapper" hidden>
        <figcaption><strong>スタイル プレビュー</strong></figcaption>
        <img id="style-preview" alt="" src="" />
      </figure>

      <button type="submit">URL を生成</button>
      <p class="message" id="message"></p>
    </form>

    <section id="result-section" class="result" hidden>
      <strong>生成された URL</strong>
      <p id="generated-url"></p>
      <button type="button" class="copy-button" id="copy-btn">
        URL をコピー
      </button>
      <button type="button" class="download-button" id="download-btn" disabled>
        JSON をダウンロード
      </button>
    </section>

    <script>
      const styleSelect = document.getElementById("style");
      const form = document.getElementById("generator-form");
      const message = document.getElementById("message");
      const resultSection = document.getElementById("result-section");
      const generatedUrlElem = document.getElementById("generated-url");
      const copyBtn = document.getElementById("copy-btn");
      const downloadBtn = document.getElementById("download-btn");
      const previewWrapper = document.getElementById("preview-wrapper");
      const previewImg = document.getElementById("style-preview");
      const previewBasePath = "style-previews";

      async function loadStyles() {
        try {
          const response = await fetch("styles.csv");
          if (!response.ok) {
            throw new Error("CSV を読み込めませんでした。");
          }
          const csvText = await response.text();
          populateStyles(csvText);
        } catch (error) {
          message.textContent = error.message;
          message.style.color = "#c62828";
        }
      }

      function populateStyles(csvText) {
        const rows = csvText
          .trim()
          .split(/\r?\n/)
          .slice(1);

        rows.forEach((row) => {
          const [name, slug] = row.split(",");
          if (!name || !slug) {
            return;
          }
          const option = document.createElement("option");
          option.value = slug.trim();
          option.textContent = name.trim();
          styleSelect.appendChild(option);
        });
      }

      function updatePreview(slug) {
        if (!slug) {
          previewWrapper.hidden = true;
          previewImg.removeAttribute("src");
          previewImg.alt = "";
          return;
        }
        const selectedOption = styleSelect.options[styleSelect.selectedIndex];
        const name = selectedOption ? selectedOption.textContent.trim() : "";
        const imageSrc = `${previewBasePath}/${slug}.png`;
        previewImg.src = imageSrc;
        previewImg.alt = `${name} のプレビュー`;
        previewWrapper.hidden = false;
      }

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        message.textContent = "";
        message.style.color = "#c62828";
        downloadBtn.disabled = true;

        const token = form.token.value.trim();
        const slug = styleSelect.value.trim();
        updatePreview(slug);

        if (!token || !slug) {
          message.textContent = "トークンとスタイルを入力してください。";
          message.style.color = "#c62828";
          resultSection.hidden = true;
          downloadBtn.disabled = true;
          return;
        }

        const url = `https://api.mapbox.com/styles/v1/mapbox/${slug}?access_token=${encodeURIComponent(
          token
        )}`;

        generatedUrlElem.textContent = url;
        resultSection.hidden = false;
        downloadBtn.disabled = false;
      });

      styleSelect.addEventListener("change", (event) => {
        const slug = event.target.value.trim();
        message.textContent = "";
        message.style.color = "#c62828";
        resultSection.hidden = true;
        downloadBtn.disabled = true;
        generatedUrlElem.textContent = "";
        updatePreview(slug);
      });

      previewImg.addEventListener("error", () => {
        previewWrapper.hidden = true;
        message.textContent = "プレビュー画像を読み込めませんでした。";
        message.style.color = "#c62828";
      });

      copyBtn.addEventListener("click", async () => {
        const url = generatedUrlElem.textContent;
        try {
          await navigator.clipboard.writeText(url);
          message.textContent = "URL をコピーしました。";
          message.style.color = "#2e7d32";
          setTimeout(() => {
            message.textContent = "";
            message.style.color = "#c62828";
          }, 2000);
        } catch (error) {
          message.textContent = "クリップボードへのコピーに失敗しました。";
          message.style.color = "#c62828";
        }
      });

      downloadBtn.addEventListener("click", async () => {
        const url = generatedUrlElem.textContent.trim();
        if (!url) {
          message.textContent = "先に URL を生成してください。";
          message.style.color = "#c62828";
          return;
        }

        downloadBtn.disabled = true;
        const originalText = downloadBtn.textContent;
        downloadBtn.textContent = "ダウンロード中...";

        try {
          const response = await fetch(url);
          if (!response.ok) {
            throw new Error(
              `JSON の取得に失敗しました (HTTP ${response.status}).`
            );
          }

          const jsonData = await response.json();
          const jsonString = JSON.stringify(jsonData, null, 2);
          const blob = new Blob([jsonString], { type: "application/json" });
          const objectUrl = URL.createObjectURL(blob);
          const filename = `${styleSelect.value || "style"}.json`;
          const anchor = document.createElement("a");
          anchor.href = objectUrl;
          anchor.download = filename;
          document.body.appendChild(anchor);
          anchor.click();
          anchor.remove();
          URL.revokeObjectURL(objectUrl);

          message.textContent = "JSON をダウンロードしました。";
          message.style.color = "#2e7d32";
          setTimeout(() => {
            message.textContent = "";
            message.style.color = "#c62828";
          }, 2000);
        } catch (error) {
          console.error(error);
          message.textContent = error.message;
          message.style.color = "#c62828";
        } finally {
          downloadBtn.disabled = false;
          downloadBtn.textContent = originalText;
        }
      });

      loadStyles();
    </script>
  </body>
</html>
